clc;
n1=[0.00000000;0.74386956;0.66832483];   %初始位置光平面1法向量
n2=[0.72422472;-0.00683280;0.68953018];	 %初始位置光平面2法向量
d=1.13085689;

x0=[0;0;0];
x1=[-5.637346;97.293991;184.52958];
x2=[83.872458;79.44437;308.470164];
x3=[-110.227859;-44.626329;550.671631];
x4=[-62.879544;-199.383353;265.965473];
x5=[-104.838603;-106.260285;149.351819];   %各点坐标



t01=0.238677241;
t02=0.465954214;
t11=0.235873606;
t12=0.474396034;
t21=0.232219456;
t22=0.479312124;
t31=0.217756889;
t32=0.482104059;
t41=0.221958069;
t42=0.469669584;
t51=0.228686998;
t52=0.467421172;



syms a01
syms a02
a01=-1* t01 * 2*pi;
a02=-1*  t02 * 2*pi;
R01=[cos(a01) -sin(a01) 0;sin(a01) cos(a01) 0;0 0 1];
R02=[cos(a02) -sin(a02) 0;sin(a02) cos(a02) 0;0 0 1];
n01=R01*n1;                                          %光平面1扫过点0时的法矢量
n02=R02*n2;											 %光平面2扫过点0时的法矢量
syms a11
syms a12
a11=-1*  t11 * 2*pi;
a12=-1*  t12 * 2*pi;
R11=[cos(a11) -sin(a11) 0;sin(a11) cos(a11) 0;0 0 1];
R12=[cos(a12) -sin(a12) 0;sin(a12) cos(a12) 0;0 0 1];
n11=R11*n1;                                          %光平面1扫过点1时的法矢量
n12=R12*n2;											 %光平面2扫过点1时的法矢量
syms a21
syms a22
a21=-1*  t21 * 2*pi;
a22=-1*  t22 * 2*pi;
R21=[cos(a21) -sin(a21) 0;sin(a21) cos(a21) 0;0 0 1];
R22=[cos(a22) -sin(a22) 0;sin(a22) cos(a22) 0;0 0 1];
n21=R21*n1;											 %光平面1扫过点2时的法矢量
n22=R22*n2;											 %光平面2扫过点2时的法矢量
syms a31
syms a32
a31=-1*  t31 * 2*pi;
a32=-1*  t32 * 2*pi;
R31=[cos(a31) -sin(a31) 0;sin(a31) cos(a31) 0;0 0 1];
R32=[cos(a32) -sin(a32) 0;sin(a32) cos(a32) 0;0 0 1];
n31=R31*n1;											 %光平面1扫过点3时的法矢量
n32=R32*n2;											 %光平面2扫过点3时的法矢量
syms a41
syms a42
a41=-1*  t41 * 2*pi;
a42=-1*  t42 * 2*pi;
R41=[cos(a41) -sin(a41) 0;sin(a41) cos(a41) 0;0 0 1];
R42=[cos(a42) -sin(a42) 0;sin(a42) cos(a42) 0;0 0 1];
n41=R41*n1;                                          %光平面1扫过点4时的法矢量
n42=R42*n2;											 %光平面2扫过点4时的法矢量
syms a51
syms a52
a51=-1*  t51 * 2*pi;
a52=-1*  t52 * 2*pi;
R51=[cos(a51) -sin(a51) 0;sin(a51) cos(a51) 0;0 0 1];
R52=[cos(a52) -sin(a52) 0;sin(a52) cos(a52) 0;0 0 1];
n51=R51*n1;                                          %光平面1扫过点5时的法矢量
n52=R52*n2;											 %光平面2扫过点5时的法矢量



%初值计算
m01=(n01(1,1)*n02(3,1)-n02(1,1)*n01(3,1))/(n01(1,1)*n02(2,1)-n02(1,1)*n01(2,1));
m02=(n01(2,1)*n02(3,1)-n02(2,1)*n01(3,1))/(n02(1,1)*n01(2,1)-n01(1,1)*n02(2,1));
m11=(n11(1,1)*n12(3,1)-n12(1,1)*n11(3,1))/(n11(1,1)*n12(2,1)-n12(1,1)*n11(2,1));
m12=(n11(2,1)*n12(3,1)-n12(2,1)*n11(3,1))/(n12(1,1)*n11(2,1)-n11(1,1)*n12(2,1));
m21=(n21(1,1)*n22(3,1)-n22(1,1)*n21(3,1))/(n21(1,1)*n22(2,1)-n22(1,1)*n21(2,1));
m22=(n21(2,1)*n22(3,1)-n22(2,1)*n21(3,1))/(n22(1,1)*n21(2,1)-n21(1,1)*n22(2,1));
m31=(n31(1,1)*n32(3,1)-n32(1,1)*n31(3,1))/(n31(1,1)*n32(2,1)-n32(1,1)*n31(2,1));
m32=(n31(2,1)*n32(3,1)-n32(2,1)*n31(3,1))/(n32(1,1)*n31(2,1)-n31(1,1)*n32(2,1));
m41=(n41(1,1)*n42(3,1)-n42(1,1)*n41(3,1))/(n41(1,1)*n42(2,1)-n42(1,1)*n41(2,1));
m42=(n41(2,1)*n42(3,1)-n42(2,1)*n41(3,1))/(n42(1,1)*n41(2,1)-n41(1,1)*n42(2,1));
m51=(n51(1,1)*n52(3,1)-n52(1,1)*n51(3,1))/(n51(1,1)*n52(2,1)-n52(1,1)*n51(2,1));
m52=(n51(2,1)*n52(3,1)-n52(2,1)*n51(3,1))/(n52(1,1)*n51(2,1)-n51(1,1)*n52(2,1));


C9=[x0(1,1) x0(2,1) x0(3,1) 1 0 0 0 0 m01;
0 0 0 0 x0(1,1) x0(2,1) x0(3,1) 1 m02;
x1(1,1) x1(2,1) x1(3,1) 1 0 0 0 0 m11;
0 0 0 0 x1(1,1) x1(2,1) x1(3,1) 1 m12;
x2(1,1) x2(2,1) x2(3,1) 1 0 0 0 0 m21;
0 0 0 0 x2(1,1) x2(2,1) x2(3,1) 1 m22;
x3(1,1) x3(2,1) x3(3,1) 1 0 0 0 0 m31;
0 0 0 0 x3(1,1) x3(2,1) x3(3,1) 1 m32;
x4(1,1) x4(2,1) x4(3,1) 1 0 0 0 0 m41;
0 0 0 0 x4(1,1) x4(2,1) x4(3,1) 1 m42;
x5(1,1) x5(2,1) x5(3,1) 1 0 0 0 0 m51;
0 0 0 0 x5(1,1) x5(2,1) x5(3,1) 1 m52;];

C3=[m01*x0(1,1) m01*x0(2,1) m01*x0(3,1);
m02*x0(1,1) m02*x0(2,1) m02*x0(3,1);
m11*x1(1,1) m11*x1(2,1) m11*x1(3,1);
m12*x1(1,1) m12*x1(2,1) m12*x1(3,1);
m21*x2(1,1) m21*x2(2,1) m21*x2(3,1);
m22*x2(1,1) m22*x2(2,1) m22*x2(3,1);
m31*x3(1,1) m31*x3(2,1) m31*x3(3,1);
m32*x3(1,1) m32*x3(2,1) m32*x3(3,1);
m41*x4(1,1) m41*x4(2,1) m41*x4(3,1);
m42*x4(1,1) m42*x4(2,1) m42*x4(3,1);
m51*x5(1,1) m51*x5(2,1) m51*x5(3,1);
m52*x5(1,1) m52*x5(2,1) m52*x5(3,1);];


D=-C3'*C3+C3'*C9*inv(C9'*C9)*C9'*C3;

[d,v]=eig(D);

X3=[d(:,3)];
X9=-inv(C9'*C9)*C9'*C3*X3;
xs=[X9(2,1) X9(3,1) X9(1,1) X9(7,1) X9(5,1) X9(6,1) X3(1,1) X3(2,1) X3(3,1)  X9(8,1) X9(4,1) X9(9,1)]; %得到初值


xc=[-20.34697;18.010528;-69.838139];   %探针坐标

options = optimset('Display','iter','Algorithm','levenberg-marquardt','MaxFunEvals',1e+8,'MaxIter',1e+8,'TolFun',1e-14,'TolX',1e-14);

[x,ansx,residual,exitflag,output]=lsqnonlin(@fun2,xs,[],[],options);

R=[x(1) x(2) x(3);x(4) x(5) x(6);x(7) x(8) x(9)];
T=[x(10); x(11); x(12)];
xwc=(R*xc+T)';  %探针全局坐标

disp(x);
disp(ansx);
